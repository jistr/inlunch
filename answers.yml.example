### REPO SETUP ###

# dictionary (keys are repo names, values are base URLs)
instack_host_repos_baseurls:

# list of packages to get from delorean_current
instack_delorean_current_pkgs: diskimage-builder,openstack-heat,instack,instack-undercloud,openstack-ironic,openstack-ironic-inspector,os-cloud-config,python-ironic-inspector-client,python-tripleoclient,tripleo-common,openstack-tripleo-heat-templates,openstack-tripleo-image-elements,openstack-tuskar-ui-extras,openstack-puppet-modules

# bash snippet
instack_host_repos_cmd: |
  yum install -y http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-5.noarch.rpm
  yum install -y https://rdoproject.org/repos/openstack-kilo/rdo-release-kilo.rpm
  curl http://trunk.rdoproject.org/centos7/delorean-deps.repo -o /etc/yum.repos.d/delorean-deps.repo
  curl http://trunk.rdoproject.org/centos7/current-tripleo/delorean.repo -o /etc/yum.repos.d/delorean.repo

  curl -o /etc/yum.repos.d/delorean-current.repo http://trunk.rdoproject.org/centos7/current/delorean.repo
  sed -i 's/\[delorean\]/\[delorean-current\]/' /etc/yum.repos.d/delorean-current.repo
  /bin/bash -c 'cat <<EOF>>/etc/yum.repos.d/delorean-current.repo

  includepkgs={{ instack_delorean_current_pkgs }}
  EOF'

  sed -i -e 's%priority=.*%priority=10%' /etc/yum.repos.d/delorean-current.repo
  sed -i -e 's%priority=.*%priority=20%' /etc/yum.repos.d/delorean.repo
  sed -i -e 's%priority=.*%priority=30%' /etc/yum.repos.d/delorean-deps.repo

  yum -y install yum-plugin-priorities
  yum -y update

# dictionary (keys are repo names, values are base URLs)
instack_uc_repos_baseurls:

# bash snippet
instack_uc_repos_cmd: "{{ instack_host_repos_cmd }}"

### TOOLS SETUP ###

tools_packages:
  - screen
  - tmux
  - vim


### HOST SETUP ###

# if set to an existing pool (e.g. 'default')
# then the pool location will not move
instack_host_libvirt_storage_pool: instack
instack_host_libvirt_storage_path: /home/vms-instack

instack_host_install_instack_undercloud_rpm: yes

instack_virt_setup_cmd: |
  export NODE_DIST=centos7

  export NODE_CPU=2
  export UNDERCLOUD_NODE_MEM=6000
  export NODE_MEM=4400

  export NODE_COUNT=6

  # workaround
  mkdir -p ~/.cache/tripleo/tripleo-incubator/scripts

  # workaround
  sudo sed -ie 's|rpm -i /|rpm -i --replacepkgs /|' /usr/share/diskimage-builder/elements/redhat-common/pre-install.d/15-remove-grub

  instack-virt-setup

instack_host_uc_http_port: 80
instack_host_uc_ssh_port: 2200


### UNDERCLOUD SETUP ###

instack_uc_install_instack_undercloud_rpm: yes

instack_install_undercloud_cmd: |
  sudo yum install -y python-rdomanager-oscplugin
  export FACTER_fqdn=$(hostname -f)
  cp /usr/share/instack-undercloud/undercloud.conf.sample ~/undercloud.conf || true

  export DIB_INSTALLTYPE_puppet_modules=source
  export DIB_REPOREF_puppetlabs_concat=15ecb98dc3a551024b0b92c6aafdefe960a4596f
  export DIB_REPOREF_puppet_cinder=0d1b1fa222338390ebd5a46e8ad7687d5dc300a3

  # workaround
  export LC_TIME=en_US.UTF-8

  openstack undercloud install

  # workaround until we have https://review.openstack.org/#/c/228190
  sudo sed -ie 's|^connection = .*|connection = sqlite:////var/lib/ironic-inspector/inspector.sqlite|' /etc/ironic-inspector/inspector.conf
  sudo ironic-inspector-dbsync --config-file /etc/ironic-inspector/inspector.conf upgrade
  sudo chown ironic-inspector /var/lib/ironic-inspector/inspector.sqlite
  sudo systemctl restart openstack-ironic-inspector
  sudo systemctl restart openstack-ironic-inspector-dnsmasq


### IMAGES SETUP ###

# Valid values are 'none', 'prebuilt', 'build'
overcloud_images_source: build

# The path is relative to the playbooks directory. Absolute path works too.
overcloud_images_prebuilt_dir: ../overcloud-images

overcloud_images_build_cmd: |
  export NODE_DIST=centos7
  export DIB_NO_TMPFS=1
  export DIB_YUM_REPO_CONF="/etc/yum.repos.d/delorean.repo /etc/yum.repos.d/delorean-current.repo /etc/yum.repos.d/delorean-deps.repo"

  export DIB_INSTALLTYPE_puppet_modules=source
  export DIB_REPOREF_puppetlabs_concat=15ecb98dc3a551024b0b92c6aafdefe960a4596f
  export DIB_REPOREF_puppet_cinder=0d1b1fa222338390ebd5a46e8ad7687d5dc300a3

  # workaround
  sudo sed -ie 's|rpm -i /|rpm -i --replacepkgs /|' /usr/share/diskimage-builder/elements/redhat-common/pre-install.d/15-remove-grub

  openstack overcloud image build --all


### OVERCLOUD PREPARATION ###

instack_prepare_for_overcloud_cmd: |
  source ./stackrc

  openstack overcloud image upload
  openstack baremetal import --json instackenv.json
  openstack baremetal configure boot
  openstack baremetal introspection bulk start
  openstack flavor create --id auto --ram 4096 --disk 40 --vcpus 1 baremetal
  openstack flavor set --property "cpu_arch"="x86_64" --property "capabilities:boot_option"="local" baremetal

  OVERCLOUD_DNS_SERVER=$(cat /etc/resolv.conf | grep nameserver | head -n1 | awk '{ print $2 }')
  CTLPLANE_SUBNET_ID=$(neutron subnet-list | grep '192.0.2.0/24' | awk '{ print $2 }')
  neutron subnet-update "$CTLPLANE_SUBNET_ID" --dns-nameserver "$OVERCLOUD_DNS_SERVER"


### STOPPING POINTS ###

# if you want to terminate the run early at a specified point, set the
# stopping_point to one of these values:
#   after_instack_libvirt_storage
#   before_instack_virt_setup
#   after_instack_virt_setup
#   after_undercloud_forwarding
#   before_instack_install_undercloud
#   before_instack_build_images
#   before_instack_prepare_for_overcloud
stopping_point:
